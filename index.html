<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0e0e0e">
    <meta name="description" content="Control your iQE050 BBQ controller via Bluetooth">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>BBQ Controller</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="stylesheet" href="styles.css?v=7">

    <!-- Auto-update: nuke old caches & force latest version -->
    <script>
    (function(){
        var APP_VER = 'v7';
        var KEY = 'bbq_ver';
        var prev = localStorage.getItem(KEY);
        if (prev && prev !== APP_VER) {
            // Version changed ‚Äî wipe everything
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    names.forEach(function(n) { caches.delete(n); });
                });
            }
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function(regs) {
                    regs.forEach(function(r) { r.unregister(); });
                });
            }
            localStorage.setItem(KEY, APP_VER);
            // Reload clean after a brief moment to let unregister finish
            setTimeout(function() { location.reload(true); }, 300);
            return;
        }
        localStorage.setItem(KEY, APP_VER);
    })();
    </script>
</head>
<body class="dark-mode">

    <!-- Top Bar -->
    <div class="top-bar">
        <div class="top-bar-left">
            <span class="app-logo">üî•</span>
            <span class="app-name">BBQ Control</span>
        </div>
        <div class="top-bar-right">
            <button id="connectBtn" class="connect-btn">
                <span class="connect-dot"></span>
                Connect
            </button>
        </div>
    </div>

    <!-- Connection Status -->
    <div id="connectionStatus" class="conn-status disconnected">
        <span class="status-text">Not Connected</span>
    </div>

    <!-- Main Content -->
    <main>

        <!-- Hero: Temperature Cards -->
        <div class="temp-cards">
            <div class="temp-card pit temp-item">
                <div class="temp-card-header">
                    <span class="temp-card-icon">üî•</span>
                    <span class="temp-card-label">PIT</span>
                </div>
                <div class="temp-card-reading">
                    <span class="temp-big temp-value" id="pitTemp">--</span>
                    <span class="temp-unit">¬∞F</span>
                </div>
                <div class="temp-card-target" id="pitTarget">Tap to set target</div>
            </div>

            <div class="temp-card-row">
                <div class="temp-card food temp-item">
                    <div class="temp-card-header">
                        <span class="temp-card-icon">ü•©</span>
                        <span class="temp-card-label">FOOD 1</span>
                    </div>
                    <div class="temp-card-reading">
                        <span class="temp-big temp-value" id="food1Temp">--</span>
                        <span class="temp-unit">¬∞F</span>
                    </div>
                    <div class="temp-card-target" id="food1Alarm">Tap to set alarm</div>
                </div>

                <div class="temp-card food temp-item">
                    <div class="temp-card-header">
                        <span class="temp-card-icon">üçñ</span>
                        <span class="temp-card-label">FOOD 2</span>
                    </div>
                    <div class="temp-card-reading">
                        <span class="temp-big temp-value" id="food2Temp">--</span>
                        <span class="temp-unit">¬∞F</span>
                    </div>
                    <div class="temp-card-target" id="food2Alarm">Tap to set alarm</div>
                </div>
            </div>
        </div>

        <!-- Live Stats Strip -->
        <div class="stats-strip">
            <div class="stat" data-action="set-fan">
                <span class="stat-icon">üí®</span>
                <span class="stat-val" id="fanSpeed">Auto</span>
                <span class="stat-lbl">Fan</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat" data-action="set-lid">
                <span class="stat-icon">üîì</span>
                <span class="stat-val" id="lidDetect">On</span>
                <span class="stat-lbl">Lid</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat" data-action="set-sound">
                <span class="stat-icon">üîä</span>
                <span class="stat-val" id="soundLevel">3</span>
                <span class="stat-lbl">Sound</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat" data-action="set-display">
                <span class="stat-icon">üí°</span>
                <span class="stat-val" id="displayLevel">3</span>
                <span class="stat-lbl">Screen</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat" data-action="set-units">
                <span class="stat-icon">üå°Ô∏è</span>
                <span class="stat-val" id="tempUnits">¬∞F</span>
                <span class="stat-lbl">Units</span>
            </div>
        </div>

        <!-- Uptime row (smaller, separate) -->
        <div class="stats-strip" style="margin-top:-10px; padding:8px 6px;">
            <div class="stat">
                <span class="stat-icon">‚è±Ô∏è</span>
                <span class="stat-val" id="uptime">--</span>
                <span class="stat-lbl">Uptime</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat">
                <span class="stat-icon">üìä</span>
                <span class="stat-val" id="avgFanDuty">--</span>
                <span class="stat-lbl">Duty</span>
            </div>
        </div>

        <!-- Fuel Gauge -->
        <div class="section-card">
            <div class="fuel-row">
                <span class="fuel-label">‚õΩ Fuel</span>
                <span class="fuel-status-text" id="fuelText">OK</span>
            </div>
            <div class="fuel-track">
                <div class="fuel-fill" id="fuelLevel" style="width: 100%"></div>
            </div>
            <div class="fuel-meta">
                <span>Temp drift: <strong id="tempDrop">--</strong></span>
            </div>
        </div>

        <!-- Temperature Graph -->
        <div class="chart-card">
            <div class="chart-header">
                <span class="chart-title">üî• Pit Temperature</span>
                <div class="chart-range-btns">
                    <button class="chart-range-btn" onclick="app.setGraphRange(15)">15m</button>
                    <button class="chart-range-btn" onclick="app.setGraphRange(30)">30m</button>
                    <button class="chart-range-btn active" onclick="app.setGraphRange(60)">1h</button>
                    <button class="chart-range-btn" onclick="app.setGraphRange(120)">2h</button>
                </div>
            </div>
            <div class="chart-canvas-wrap">
                <canvas id="tempChart"></canvas>
            </div>
            <div class="chart-legend">
                <span><span class="chart-legend-dot" style="background:#ff6b35"></span>Pit</span>
                <span><span class="chart-legend-dot" style="background:#26de81"></span>Food 1</span>
                <span><span class="chart-legend-dot" style="background:#ffc048"></span>Food 2</span>
            </div>
        </div>

        <!-- Programming / Automation Card -->
        <div class="section-card prog-card">
            <div class="prog-header">
                <span class="prog-icon">‚öôÔ∏è</span>
                <span class="prog-title">Cook Programming</span>
            </div>

            <!-- Pit Alarm -->
            <div class="prog-group">
                <div class="prog-group-title">Pit Alarm</div>
                <div class="prog-row" data-prog="pit-alarm">
                    <span class="prog-label">Deviation Alarm</span>
                    <span class="prog-val" id="progPitAlarm">Off</span>
                </div>
            </div>

            <!-- Delay Timer -->
            <div class="prog-group">
                <div class="prog-group-title">Delay Timer</div>
                <div class="prog-row" data-prog="delay-time">
                    <span class="prog-label">Timer</span>
                    <span class="prog-val" id="progDelayTime">Off</span>
                </div>
                <div class="prog-row" data-prog="delay-pit-set">
                    <span class="prog-label">Pit Temp After Timer</span>
                    <span class="prog-val" id="progDelayPitSet">Off</span>
                </div>
            </div>

            <!-- Food 1 Trigger -->
            <div class="prog-group">
                <div class="prog-group-title">Food 1 Trigger</div>
                <div class="prog-row" data-prog="food1-trigger">
                    <span class="prog-label">When Food 1 Reaches</span>
                    <span class="prog-val" id="progFood1Trigger">Off</span>
                </div>
                <div class="prog-row" data-prog="food1-pit-set">
                    <span class="prog-label">Change Pit To</span>
                    <span class="prog-val" id="progFood1PitSet">Off</span>
                </div>
            </div>

            <!-- Food 2 Trigger -->
            <div class="prog-group">
                <div class="prog-group-title">Food 2 Trigger</div>
                <div class="prog-row" data-prog="food2-trigger">
                    <span class="prog-label">When Food 2 Reaches</span>
                    <span class="prog-val" id="progFood2Trigger">Off</span>
                </div>
                <div class="prog-row" data-prog="food2-pit-set">
                    <span class="prog-label">Change Pit To</span>
                    <span class="prog-val" id="progFood2PitSet">Off</span>
                </div>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer>BBQ Controller &middot; iQE050</footer>

    <!-- Toast Notifications -->
    <div id="toastContainer"></div>

    <!-- Modal Dialog (bottom sheet style) -->
    <div id="modal" class="modal-overlay" onclick="if(event.target===this){cancelModal();}">
        <div class="modal-sheet" onclick="event.stopPropagation()">
            <div class="modal-handle"></div>
            <h3 id="modalTitle" class="modal-title">Set Temperature</h3>
            <div class="modal-readout">
                <span id="modalValueDisplay" class="modal-num">225</span>
                <span id="modalValueUnit" class="modal-unit">¬∞F</span>
            </div>
            <!-- Slider mode -->
            <div id="modalSliderSection" class="modal-slider-section">
                <input type="range" id="modalSlider" class="slider modal-slider" min="150" max="400" value="225" step="5"
                       oninput="updateModalValue(this.value)">
                <div class="slider-labels modal-labels">
                    <span id="modalMinLabel">150¬∞F</span>
                    <span id="modalMaxLabel">400¬∞F</span>
                </div>
            </div>
            <!-- Pill picker mode -->
            <div id="modalPillsSection" class="modal-pills-section hidden">
                <div id="modalPills" class="modal-pills"></div>
            </div>
            <div class="modal-actions">
                <button class="modal-cancel" id="modalCancel" onclick="cancelModal();">Cancel</button>
                <button class="modal-set" id="modalConfirm" onclick="confirmModal();">Set</button>
            </div>
        </div>
    </div>

    <!-- Hidden elements for backward compat with existing JS -->
    <span id="lastEchoText" style="display:none">--</span>
    <span id="lastEchoVerify" style="display:none"></span>
    <span id="soundValue" style="display:none">3</span>
    <span id="displayValue" style="display:none">3</span>
    <span id="pitSetValue" style="display:none">225¬∞F</span>
    <span id="food1AlarmValue" style="display:none">Off</span>
    <span id="food2AlarmValue" style="display:none">Off</span>

    <!-- Scripts -->
    <script src="bluetooth.js?v=7"></script>
    <script src="app.js?v=7"></script>
</body>
</html>
